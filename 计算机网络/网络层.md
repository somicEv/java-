<!-- TOC -->

- [网络层](#网络层)
    - [一、 IP](#一-ip)
    - [二、 路由控制](#二-路由控制)
            - [1、路由控制表形成方式](#1路由控制表形成方式)
            - [2、路由控制表](#2路由控制表)
            - [3、路由算法](#3路由算法)
            - [4、路由协议](#4路由协议)

<!-- /TOC -->

# 网络层

网络层的主要作用是实现点对点之间的通信，可以跨越不同链路完成两端节点的通信。
主要有IP和ICMP两个协议组成。

---

## 一、 IP

IP主要由三大作用模块：1、IP地址 2、路由（最终节点为止的转发） 3、IP分包和组包

IP地址相当于网络环境中每个主机的唯一标识，在TCP/IP中每个主机都必须设定自己的IP地址。

1、**定义**：IPv4地址是由32位2进制数组成，现在是使用每8位一组，分成4组，中间以“.”分割，为了方便记忆转换成10进制。

2、**组成**：IP地址是由“网络地址”和“主机地址”组成。如果网络地址相同，主机地址不同，说明是属于同一网段。

3、**编址方式**： IP地址的编址方式经历了三个历史阶段：
- 分类
- 子网划分
- 无分类

1).**分类**

由两部分组成，网络号和主机号，其中不同分类具有不同的网络号长度，并且是固定的。

IP 地址 ::= {< 网络号 >, < 主机号 >}


2).**子网划分**
通过在主机号字段中拿一部分作为子网号，把两级 IP 地址划分为三级 IP 地址。

IP 地址 ::= {< 网络号 >, < 子网号 >, < 主机号 >}

要使用子网，必须配置子网掩码。一个 B 类地址的默认子网掩码为 255.255.0.0，如果 B 类地址的子网占两个比特，那么子网掩码为 11111111 11111111 11000000 00000000，也就是 255.255.192.0。

注意，外部网络看不到子网的存在。

3).**无分类**
无分类编址 CIDR 消除了传统 A 类、B 类和 C 类地址以及划分子网的概念，使用网络前缀和主机号来对 IP 地址进行编码，网络前缀的长度可以根据需要变化。

IP 地址 ::= {< 网络前缀号 >, < 主机号 >}

CIDR 的记法上采用在 IP 地址后面加上网络前缀长度的方法，例如 128.14.35.7/20 表示前 20 位为网络前缀。

CIDR 的地址掩码可以继续称为子网掩码，子网掩码首 1 长度为网络前缀的长度。

一个 CIDR 地址块中有很多地址，一个 CIDR 表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为路由聚合，也称为 **构成超网** 。

在路由表中的项目由“网络前缀”和“下一跳地址”组成，在查找时可能会得到不止一个匹配结果，应当采用最长前缀匹配来确定应该匹配哪一个。

## 二、 路由控制
---
在网络通信中如果只有IP地址就像出去旅游只知道起点和终点，而不知怎么才能从起点到达终点，这时就需要类似“路线图”一样的东西了，在网络通信中路线图就是路由控制表。通信就是基于控制表来发送数据的。

####1、路由控制表形成方式
- 静态路由：由管理员手动设置也叫**静态路由**。静态路由是事先在路由器上设置好路由器与主机的联系的一种方式。

- 动态路由：通过路由协议运行自动生成路由控制表的方式叫做**动态路由**。这个过程中，路由器之间会互相发送自己已经的网络信息，以接力的方式进行传递，直到整个网络都了解，路由控制表也就完成了。

####2、路由控制表
路由控制表中记录着网络地址与下一“跳”应该发送到的路由器的地址。

在发送IP包时，应该先确认IP首部中的目标IP地址中的网络地址，在从路由控制表中查找到相同的网络地址，在将数据包转发到下一个路由器。如果控制表中存在多条相同的路径，则选择一条最符合的路径。

![路由控制表](../image/计算机网络/路由控制表.png)

- **默认路由**：是指路由表中任何一个地址都能匹配上的记录。一般标记为0.0.0.0或者default

- **主机路由**：“IP地址/32”这种表示方式属于主机路由。它的意思是指用整个IP地址进行路由，如不是只有网络部分进行路由。

- **回环地址**：是在同一个计算机上的程序之间进行网络通信时所使使用的一个默认地址。计算机中使用127.0.0.1作为回环地址，与之匹配的主机名称为localhost。使用这个主机名或IP地址，数据不会发送到网络。

####3、路由算法
主要有两种算法：**距离向量算法、链路状态算法**。

**距离向量算法**
根据距离（代价）和方向决定目标网络或者目标主机位置的一种算法。路由器之间可以互换目标网络的方向和距离的相关信息，以这些信息为基础生成路由控制表。

 **链路状态算法**
根据路由器了解整个网络链接状态的基础上生成的路由控制表的一种方法。在这种标准中，每台路由器获取的网络链接状态必须保持一致。

####4、路由协议
现在使用的路由协议主要有两种类型：IGP、BGP。
- IGP：自治系统内部使用的路由控制采用的就是域内路由协议。

- BGP：在自治系统之间使用的路由协议就是域间路由协议。

自治系统指的是可以自己制定路由策略并能在一个小范围中实行这个策略的小型单位。例如：区域网络、某公司或组织。

**内部网关协议 RIP**

RIP 是一种基于距离向量的路由选择协议。距离是指跳数，直接相连的路由器跳数为 1。跳数最多为 15，超过 15 表示不可达。

RIP 按固定的时间间隔(30秒一次)仅和相邻路由器交换自己的路由表，经过若干次交换之后，所有路由器最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址。

RIP 协议实现简单，开销小。但是 RIP 能使用的最大距离为 15，限制了网络的规模。并且当网络出现故障时，要经过比较长的时间才能将此消息传送到所有路由器。

**内部网关协议 OSPF**

开放最短路径优先 OSPF，是为了克服 RIP 的缺点而开发出来的。

开放表示 OSPF 不受某一家厂商控制，而是公开发表的；最短路径优先表示使用了 Dijkstra 提出的最短路径算法 SPF。

OSPF 具有以下特点：

向本自治系统中的所有路由器发送信息，这种方法是洪泛法。
发送的信息就是与相邻路由器的链路状态，链路状态包括与哪些路由器相连以及链路的度量，度量用费用、距离、时延、带宽等来表示。
只有当链路状态发生变化时，路由器才会发送信息。
所有路由器都具有全网的拓扑结构图，并且是一致的。相比于 RIP，OSPF 的更新过程收敛的很快。

**外部网关协议 BGP**

BGP（Border Gateway Protocol，边界网关协议）

AS 之间的路由选择很困难，主要是由于：

互联网规模很大；
各个 AS 内部使用不同的路由选择协议，无法准确定义路径的度量；
AS 之间的路由选择必须考虑有关的策略，比如有些 AS 不愿意让其它 AS 经过。
BGP 只能寻找一条比较好的路由，而不是最佳路由。

每个 AS 都必须配置 BGP 发言人，通过在两个相邻 BGP 发言人之间建立 TCP 连接来交换路由信息。



